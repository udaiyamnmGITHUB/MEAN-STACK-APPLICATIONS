var express      = require('express'),
    passport     = require('passport'),
    LdapStrategy = require('./lib/passport-ldapauth').Strategy;

var log4js = require('log4js');
var logger = log4js.getLogger();

var OPTS = {
  server: {
    url: 'ldap://localhost:1389',
    searchBase: 'ou=passport-ldapauth',
    searchFilter: '(uid={{username}})',
    log4js: log4js
  }
};

var app = express();

passport.serializeUser(function(user, done) {
  console.log('user : ' + user);
  console.log('done : ' + done);
  console.log('serializeUser was called');
  done(null, 1);
});

passport.deserializeUser(function(obj, done) {
  console.log('deserializeUser was called');
  done(null, obj);
});

passport.use(new LdapStrategy(OPTS, function(user, done) {
  done(null, user);
}));

app.use(require('cookie-parser')());
app.use(require('body-parser').json());
app.use(require('express-session')({
  secret: 'secret',
  store: new require('express-session').MemoryStore()
}))
app.use(passport.initialize());
app.use(passport.session());

app.all('*', function(req, res, next) {
  console.log('Request', req.headers, req.body);
  next();
});

app.get('/login', function(req, res) {
  console.log('GET');
  if (req.user) {
    console.log('OK');
    res.send(200, {status: 'ok'});
  } else {
    console.log('NOK');
    res.send(403);
  }
});

app.post('/login', passport.authenticate('ldapauth'), function(req, res) {
  console.log('POST');
  res.send({status: 'ok'});
});

app.listen(8080);
